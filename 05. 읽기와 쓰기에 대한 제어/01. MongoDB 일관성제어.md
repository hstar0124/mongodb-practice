# MongoDB ì¼ê´€ì„± ì œì–´

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9100aaf1-43df-4932-914c-eeb18419af99/Untitled.png)

- **Single Document**
    - ê¸°ë³¸ì ìœ¼ë¡œ ì›ìì„±ì„ ë³´ì¥
    - ë³µì œë¥¼ í†µí•´ HAë¥¼ êµ¬ì„±í•˜ê¸° ë•Œë¬¸ì— ì–¸ì  ê°€ëŠ” ì¼ê´€ëœ ë°ì´í„°ë¥¼ ë³´ì¥í•œë‹¤.
- **Transaction**
    - ë©€í‹° ë„íë¨¼íŠ¸ì— ëŒ€í•´ ì›ìì„± ë³´ì¥
    - ê¶Œì¥ë˜ì§€ëŠ” ì•Šì§€ë§Œ ê¸°ëŠ¥ìƒ ì¡´ì¬í•œë‹¤.
- **Replica Set Member**
    - ë™ì¼í•œ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ë©¤ë²„ì— ì €ì¥í•˜ëŠ” Replica Setì„ í†µí•´ HAë¥¼ êµ¬ì„±í•˜ê³  ë©¤ë²„ ê°„ì— ë°ì´í„° ì¼ê´€ì„± ì œì–´ê°€ í•„ìš”í•¨
- **Sharded Cluster Shard**
    - ë°ì´í„° ë¶„ì‚°ì´ ë˜ì–´ ìƒ¤ë“œê°„ì— ë™ì¼í•œ ë°ì´í„°ë¥¼ ê°€ì§€ì§€ ì•Šê²Œ ì œì–´ê°€ í•„ìš”í•¨

## Read Preference

<aside>
ğŸ’¡ Read ì— ëŒ€í•œ ìš”ì²­ì„ ì–´ë–¤ ë©¤ë²„ê°€ ì²˜ë¦¬í•˜ëŠ”ì§€ ì •í•˜ëŠ” ì˜µì…˜

</aside>

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c69b53d9-dc6b-47d3-a5d9-7a41db77e2b2/Untitled.png)

- ê¸°ë³¸ì ìœ¼ë¡œ ì•„ë¬´ ì„¤ì •ì„ í•˜ì§€ ì•Šì€ ê²½ìš° Readì— ëŒ€í•œ ìš”ì²­ë„ Primaryê°€ ì²˜ë¦¬í•¨
- Read Preference ì„¤ì •ì„ í†µí•´ Read íŠ¸ë˜í”½ì„ ë¶„ì‚° ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
- Replica Setê³¼ Sharded Cluster ì—ì„œ ë‹¤ ì‚¬ìš© ê°€ëŠ¥

### Read Preference ì¢…ë¥˜

| primary | ë¬´ì¡°ê±´ Primaryë¡œ ì½ê¸° ìš”ì²­(Primaryê°€ ì—†ìœ¼ë©´ ì‹¤íŒ¨ë¨) |
| --- | --- |
| primaryPreferred | ê°€ëŠ¥í•˜ë©´ Primaryì—ì„œ ì½ê³  ì—†ìœ¼ë©´ Secondaryë¡œ ìš”ì²­ |
| secondary | ë¬´ì¡°ê±´ Secondaryë¡œ ì½ê¸° ìš”ì²­ |
| secondaryPreferred | ê°€ëŠ¥í•˜ë©´ Secondaryì—ì„œ ì½ê³  ì—†ìœ¼ë©´ Primary ë¡œ ìš”ì²­ |
| nearest | í‰ê·  Ping ì‹œê°„ì„ ê¸°ë°˜ìœ¼ë¡œ ì§€ì—°ìœ¨ì´ ê°€ì¥ ë‚®ì€ ë©¤ë²„ë¡œ ìš”ì²­(ë©€í‹° ë¦¬ì „ì¼ë•Œ ìœ ìš©í•¨) |
- secondary ë¡œ í•  ê²½ìš° ë³µì œê°€ ë˜ì§€ ì•Šì•„ ì§€ì—°ëœ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‹¤.
- ì§€ì—°ëœ ë°ì´í„°ê°€ í—ˆìš©ì´ ê°€ëŠ¥í•˜ê³  ë¶ˆê°€ëŠ¥í•œ ê²½ìš°ê°€ ìˆë‹¤. ìƒí™©ì— ë”°ë¼ ì ì ˆí•˜ê²Œ ì ìš©í•´ì•¼í•œë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c3d86309-03c7-489d-ada0-a7234adc656f/Untitled.png)
    
- ReadPreferenceê°€ Primary ì¼ ë•Œì™€  Secondary ì¼ ë•Œ ì°¨ì´
    
    ```python
    from pymongo import MongoClient
    from pymongo.read_preferences import ReadPreference
    import certifi
    
    conn = "mongodb+srv://mongo_user:user1234@cluster0.8b0eqwp.mongodb.net/"
    client = MongoClient(conn, tlsCAFile=certifi.where())
    db = client.test
    
    db.fruits.insert_many([
        {
            "name": "melon",
            "qty": 1000,
            "price": 16000
        },
        {
            "name": "starberry",
            "qty": 100,
            "price": 10000
        },
        {
            "name": "grape",
            "qty": 1500,
            "price": 5000
        }
    ])
    
    query_filter = { "name": "melon" }
    while True:
        # res = db.fruits.find_one(query_filter)
        res = db.fruits.with_options(read_preference=ReadPreference.SECONDARY).find_one(query_filter)
        print(res)
    ```
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ff035743-b4aa-405f-abf5-06496949feb0/Untitled.png)
    

**Connection Stringì—ì„œ ì˜µì…˜ ì£¼ëŠ” ë°©ë²•**

```python
from pymongo import MongoClient
from pymongo.read_preferences import ReadPreference
import certifi

# conn = "mongodb+srv://mongo_user:user1234@cluster0.8b0eqwp.mongodb.net/"
conn = "mongodb+srv://mongo_user:user1234@cluster0.8b0eqwp.mongodb.net/?readPreference=secondary"
client = MongoClient(conn, tlsCAFile=certifi.where())
db = client.test

db.fruits.insert_many([
    {
        "name": "melon",
        "qty": 1000,
        "price": 16000
    },
    {
        "name": "starberry",
        "qty": 100,
        "price": 10000
    },
    {
        "name": "grape",
        "qty": 1500,
        "price": 5000
    }
])

query_filter = { "name": "melon" }
while True:
    res = db.fruits.find_one(query_filter)
    # res = db.fruits.with_options(read_preference=ReadPreference.SECONDARY).find_one(query_filter)
    print(res)
```

## Read/Write Concern

### Write Concern

- ëª‡ê°œì˜ ë©¤ë²„ê¹Œì§€ ë³µì œí•˜ê³  ì‚¬ìš©ìì—ê²Œ ë°˜í™˜í• ì§€ ì •í•˜ëŠ” ì˜µì…˜
- ë ˆí”Œë¦¬ì¹´ ì…‹ ë©¤ë²„ê°„ì— ë™ê¸°í™” ì •ë„ ì œì–´í•˜ëŠ”ë° ì‚¬ìš©
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/29978d28-275e-485a-ab1d-d31a507172a7/Untitled.png)
    
    **majority : ê³¼ë°˜ìˆ˜**
    

- ì£¼ ëª©ì ì€ ë¡¤ë°±ì„ ë°©ì§€í•˜ëŠ” ê²ƒì¸ë° ì•„ë˜ ì˜ˆì œì—ì„œ ë³´ë©´, ë°ì´í„° ì„¼í„° 1ê³¼ 2 ì‚¬ì´ì— ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ Primaryê°€ ë°”ë€Œê²Œ ë˜ë©´ ë¡¤ë°±ì´ ë°œìƒë˜ê²Œ ëœë‹¤. ë¡¤ë°±ì´ ë°œìƒë˜ë©´ ìë™ìœ¼ë¡œ ëª½ê³ DBì—ì„œ ì ìš©í•˜ì§€ ì•Šê³  íŒŒì¼ì´ ë‚¨ê²¨ì§„ë‹¤. ì´ë¥¼ ì–´ë–»ê²Œ í•´ì•¼í• ì§€ëŠ” ê°œë°œìê°€ ê³ ë¯¼í•´ ë³´ì•„ì•¼ í•œë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/49cd116a-42a8-4fa0-b0af-b3b536096411/Untitled.png)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f21d76f0-b027-409d-8fe1-28b6eff7100c/Untitled.png)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/68395894-d453-42d2-a7eb-69ea4497b712/Untitled.png)
    

### Read Concern

| local | ë³µì œë¥¼ í™•ì¸í•˜ì§€ ì•Šê³  ìš”ì²­í•œ Memberì˜ í˜„ì¬ ë°ì´í„°ë¥¼ ë°˜í™˜ |
| --- | --- |
| available | localê³¼ ë™ì¼í•˜ì§€ë§Œ, ê³ ì•„ Documentë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤ |
| majority | Member ê³¼ë°˜ìˆ˜ê°€ ë“¤ê³  ìˆëŠ” ë™ì¼í•œ ë°ì´í„° ë°˜í™˜ |
| linearizable | ì¿¼ë¦¬ ìˆ˜í–‰ ì „ì— ëª¨ë“  Majority Writeê°€ ë°˜ì˜ëœ ê²°ê³¼ ë°˜í™˜ |
| snapshot | íŠ¹ì • ì‹œì ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ë°˜í™˜(Point-In-Time Query) |

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/84bda32f-2b59-4343-8093-37ef8987e544/Untitled.png)

## Causal Consistency

- ëª½ê³ DBì—ì„œëŠ” ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë‹¤ì–‘í•œ ì„œë¹„ìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì‚¬ìš©í•  ê²½ìš°ê°€ ìˆì–´ì„œ ì•Œê³  ìˆì–´ì•¼ í•œë‹¤.

- Causal Consistencyê°€ ì ìš©ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3a5c93d4-dac1-4df3-9ccc-a29752a11763/Untitled.png)
    

- Causal Consistencyê°€ ì ìš©ëœ ê²½ìš°
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5ef0a2c2-ef90-43fa-9e35-41e1369430e8/Untitled.png)
    

### Linearizable Read Concern vs Causal Consistency

- 3.6 ë²„ì „ ì´ì „ì—ì„œëŠ” Read Your Own Writesë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ Write Concern â€œmajorityâ€ì™€ Read Concern â€œlinearizableâ€ì„ ì‚¬ìš©í–ˆë‹¤.
- Causal ConsistencyëŠ” í•˜ë‚˜ì˜ Threadì—ì„œ ì‘ì—…í•˜ê³  Linearizable Read Concernì€ ë‹¤ë¥¸ Sessionì˜ ì—¬ëŸ¬ Threadì˜ ì‘ì—…ì„ ì ìš©í•˜ì—¬ ê¸°ë‹¤ë¦°ë‹¤.
- Linearizable Read Concernì€ Primary Readì— ëŒ€í•´ì„œë§Œ ê°€ëŠ¥í•˜ê³  Causal Consistencyì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.

### Majority Read/Write Concern Example

- Secondaryë¡œ ë³µì œí•˜ëŠ” ì¤‘ì— 123ì„ ì½ìœ¼ë ¤ê³  í•˜ë©´ ì—†ë‹¤ëŠ” ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2bfa16dc-b58d-42a7-aaab-0d0918cda9b7/Untitled.png)
    

- ë‚´ê°€ ì…ë ¥í•œ ê²ƒì€ ë°”ë¡œ ì½ì„ ìˆ˜ ìˆê²Œ concernì„ Majorityë¡œ ë³€ê²½í•´ë„ ë°”ë¡œ ë³´ì§€ ëª»í•  ìˆ˜ë„ ìˆë‹¤. update í•˜ëŠ” ë„ì¤‘ì— ì½ìœ¼ë ¤ê³  í•˜ë©´ ì—†ë‹¤ë¼ê³  ê²°ê³¼ë¥¼ ë°˜í™˜ ë°›ì„ ìˆ˜ ìˆë‹¤. (ì™ ë§Œí•˜ë©´ì€ ë°”ë¡œ ë³¼ ìˆ˜ ìˆì§€ë§Œ ê°€ëŠ¥ì„±ì´ ìˆë‹¤)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/381a7cbb-24b8-403f-a63b-bd0567ebd916/Untitled.png)
    

- ìœ„ì—ì„œ ë°œìƒí•œ ê°€ëŠ¥ì„±ì„ ì¡ê¸° ìœ„í•´ì„œ Causal Consistencyë¥¼ ì¡ìœ¼ë©´ ëœë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c794e4e0-d249-4915-b49e-e767d3b2b80d/Untitled.png)
    

## Transaction

<aside>
ğŸ’¡ ëª½ê³  DB 4.0 ë¶€í„° ì§€ì›í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, **ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥**í•œë‹¤. ëª½ê³ DBì˜ ì¥ì ì€ ìœ ì—°í•˜ê³  ë‹¤ì–‘í•œ í˜•íƒœë¡œ êµ¬ì„±í•˜ëŠ” ê²ƒì¸ë° íŠ¸ëœì­ì…˜ì„ ì“°ëŠ” ê²ƒì€ ì •ê·œí™”ë¥¼ í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì´ê¸° ë•Œë¬¸ì´ë‹¤.

</aside>

- íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ 
    
    ì—¬ëŸ¬ ì‘ì—…ì— ëŒ€í•´ì„œ í•˜ë‚˜ì˜ ë…¼ë¦¬ì ì¸ ë‹¨ìœ„ë¡œ ì·¨ê¸‰í•˜ì—¬ ì›ìì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©
    
    ex1) ì€í–‰ ì†¡ê¸ˆ ì„œë¹„ìŠ¤
    
    ex2) ì˜ˆì•½ ì‹œìŠ¤í…œ
    

- ì „í†µì ì¸ RDBMSì—ì„œ ì—¬ëŸ¬ ì‘ì—…ì„ í•˜ë‚˜ì˜ ë…¼ë¦¬ì ì¸ ë‹¨ìœ„ë¡œ ë´ì•¼í•  ë•Œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê³  ì´ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ ë½ì„ ì‚¬ìš©í•œë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7a72f6e8-df88-46d5-a138-84e34d8669e6/Untitled.png)
    
- MongoDB íŠ¸ëœì­ì…˜ì˜ ëª¨ìŠµ
    
    ë½ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ë™ì‹œì— ê°™ì€ ì˜¤ë¸Œì íŠ¸ë¥¼ ì°¸ì¡°í•˜ë ¤ê³  í•˜ë©´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¨ë‹¤. MongoDB 4.0 ë²„ì „ì—ì„œëŠ” ì‹¤íŒ¨ì— ëŒ€í•œ ë¡œì§ì„ ë”°ë¡œ êµ¬í˜„ì„ í–ˆì–´ì•¼ í–ˆë‹¤. ê·¸ ì´í›„ì—ëŠ” TransientTransactionErrorë¥¼ ìë™ìœ¼ë¡œ Retryë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í–ˆë‹¤. í•˜ì§€ë§Œ ì ìš©ì‹œí‚¨ ì‘ì—…ì„ ë³µêµ¬ì‹œí‚¤ëŠ” ì‘ì—…ì„ í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ë§¤ìš° ë–¨ì–´ì§„ë‹¤.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/497bfbfc-b850-4c72-b6b4-ee84562643e4/Untitled.png)